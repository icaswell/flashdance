from collections import defaultdict
import regex as re
import jieba




LEVELS = [
    "hsk1",
    "hsk2",
    "hsk3",
    "hsk4",
    "hsk5",
    "hsk6",
    "stront1",
    "weeb1",
    ]

CITOLEVEL = defaultdict(list)

for level in LEVELS:
  with open(f"resources/vocab_separate/{level}.tsv", "r") as f:
    for i, line in enumerate(f):
      parts = line.split("\t")
      if len(parts) != 3:
        raise ValueError(f"Line {i} should have three tab-separated values but doesn't: {line}")
      ci, _, _ = parts
      CITOLEVEL[ci].append(level)



testbed = [("v3-prompted", """
第四集：蓝忘机决定去收集四块阴棉花糖。魏无羡偷偷跟着他。他们与一位名叫宋岚的邪恶负鼠修行者发生了争斗，险胜。他们拿走了他的一块阴棉花糖。

蓝忘机和魏无羡小心翼翼地走进了黑暗的小巷。在月光下，他们看到了一块闪闪发光的物体。蓝忘机的眼睛亮了起来，他知道那就是他要找的东西之一。

就在他们准备拿起物品时，一道阴冷的声音响起：“停下！那是我的！”他们转身一看，只见一位穿着黑色斗篷的人站在那里，手里拿着一块与他们看到的物品一模一样的阴棉花糖。

“你是谁？”蓝忘机问道，他的手已经悄悄移到了腰间的剑。

“我是宋岚，你们不该来这里。这块阴棉花糖是我的！”宋岚冷冷地说道，他的眼中闪烁着凶光。

魏无羡忍不住嘲讽道：“哦，难怪你们负鼠修行者喜欢收集这种垃圾，你们就是习惯住在垃圾堆里的家伙。”

宋岚勃然大怒，他挥舞着手中的武器，向他们袭来。蓝忘机和魏无羡立刻迎了上去，他们的剑与宋岚的兵器交错在一起，激起火花。

激战过后，蓝忘机和魏无羡艰难地击败了宋岚。他们喘着粗气，将宋岚身上的一块阴棉花糖夺了过来。他们知道，这只是他们旅程的一小步，他们必须继续前进，收集剩下的阴棉花糖，解开这个谜团。"""),
("v2-prompted", """"
第四集：蓝忘机出发去收集四块阴棉花糖。魏无羡偷偷跟着他。他们与一个名叫宋岚的邪恶的负鼠修士发生了一场激烈的战斗，几乎陷入了困境。他们夺走了宋岚的一块阴棉花糖。

积累了许多经验，他们辛苦地将阴棉花糖放入袋子里，于是继续向前走去。在他们行进的过程中，一块巧克力掉到了地上，给了他们一丝甜蜜的慰藉。

当他们穿过一片树林时，突然出现了一些困难。但是，他们十分自然地应对了这些挑战，展现出了他们的勇气和智慧。

在追赶时，魏无羡开始后悔跟随蓝忘机，但他知道现在不是抱怨的时候。他们赶紧行动起来，希望尽快夺回被宋岚抢走的一块阴棉花糖。

当他们来到一个海洋的边缘时，他们发现了一种新的技术，可以帮助他们解决一些难题。他们兴奋地学习，并决定利用这项技术继续前进。

蓝忘机展示了他的艺术天赋，用他的信息收集技巧找到了下一块阴棉花糖。而魏无羡则在一旁活泼地探索着，发现了一些隐藏的线索。

虽然魏无羡讨厌使用科学方法，但他意识到在这种情况下没有别的选择。他们必须收集所有四块阴棉花糖，这是唯一的方法来解决当前的困境。

最终，他们找到了宋岚藏匿的地方，发动了一场激烈的战斗。在一场斗争中，他们成功夺回了一块阴棉花糖，为他们的任务取得了重要的进展。"""),
("v1-prompted", """"
第一集：兰氏修行垃圾箱。魏无羡，温宁，温情，以及所有其他修行者前往兰家垃圾箱修行他们的功夫。他们遇见了蓝湛和蓝曦臣。大家都对他们是多么美丽的浣熊印象深刻。蓝湛认为魏无羡太不拘一格了，但我们互相体谅，子女们关系更好了。

邮件中，亲密关系，棺材，和安排一切在垃圾箱里都变得不可避免。魏无羡和温情的感情似乎有了一些发展，但他们也被棺材中的某些安排所困扰。

我很羡慕！这个地方是如此神秘，数不尽的宝贝都在这里等待着被发现。但是这里也隐藏着一些不为人知的危险。有些修行者认为他们是嬉皮士，但是他们并不知道这背后可能隐藏着的危险。

垃塌的声音在夜晚回荡。修行者们都很年轻，但这次事件使他们不得不面对生死。在这个关键时刻，有人问魏无羡：“你找对象吗？”但魏无羡只是拒绝了这个问题，因为他对自己的心思还不清楚。

读书会在兰家垃圾箱里变得越来越频繁。大家不仅学习武术，还彼此吸引。但他们也发现了一些截图，似乎在暗示着垃圾箱里发生了更多的事情。"""),
("freeform","""
第四集：蓝忘机开始收集四片阴棉花糖。魏无羡偷偷跟着他。他们与一位名为宋岚的邪恶负鼠修士发生了争斗，几乎以微弱优势获胜。他们夺取了他手中的一块阴棉花糖。

蓝忘机和魏无羡踏上了一段充满挑战的旅程。他们沿着破烂不堪的巷子穿行，寻找着隐藏在废墟之中的珍贵宝物。每一步都充满了危险，但他们的心却充满了决心。

当他们来到一个荒废的角落时，突然出现了一名陌生的修士。这位修士手持一把闪闪发光的剑，目光如炬地盯着他们。他自称为宋岚，一个专门以掠夺为生的恶徒。

“你们两个是来抢我的宝物的吧？”宋岚的声音冰冷而嘶哑。“但是，你们永远也不会得手！”他挥舞着手中的剑，发出刺耳的呼啸声。

蓝忘机和魏无羡毫不畏惧地面对着宋岚。他们默契地配合着，以强大的战斗技巧击退了宋岚的攻击。然而，这场战斗并不容易，他们付出了巨大的努力才取得了胜利。最终，他们夺取了宋岚手中的一块阴棉花糖，为他们的使命迈出了重要的一步。
""")]

def get_levels(s):
  toks = set(jieba.cut(s))
  levels = defaultdict(set)
  for tok in toks:
    levs_i = CITOLEVEL.get(tok, [])
    for lev_ij in levs_i:
      levels[lev_ij].add(tok)
    if not levs_i:
      if re.search("\p{Han}", tok):
        levels["other"].add(tok)
  return levels


for idd, text in testbed:
  print("\n\n--------------------------------------------")
  print(f"# {idd}")
  levels = get_levels(text)
  for lev in LEVELS + ["other"]:
    ci = levels[lev]
    if not ci: continue
    print(f"{lev} ({len(ci)}): {' '.join(ci)}")


